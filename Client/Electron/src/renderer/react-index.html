<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' http://51.112.215.253:5000 http://3.28.190.141:5000; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>GhostSwitch VPN</title>
    <!-- ‚úÖ LINK TO EXTERNAL CSS FILE -->
    <link rel="stylesheet" href="react-index.css">
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="main-container">
        <div class="app-card">
            
            <!-- Header Section -->
            <div class="app-header">
                <div class="app-logo">
                    <div class="shield-icon">üõ°Ô∏è</div>
                    <h1 class="app-title">GhostSwitch VPN</h1>
                </div>
                <p class="app-subtitle">Secure. Private. Fast.</p>
            </div>

            <!-- System Status -->
            <div class="system-status">
                <div class="status-title">System Status:</div>
                <div class="status-item">
                    <span class="status-text" id="appVersion">App Version: 1.0.0</span>
                </div>
                <div class="status-item">
                    <span class="status-icon success">‚úì</span>
                    <span class="status-text" id="wireGuardStatus">WireGuard: Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-icon success">‚úì</span>
                    <span class="status-text" id="backendStatus">Backend: Testing...</span>
                </div>
            </div>

            <!-- Authentication Container -->
            <div class="auth-container">
                
                <!-- Tab Navigation -->
                <div class="auth-tabs">
                    <button id="loginTab" class="auth-tab active" onclick="switchAuthTab('login')">
                        Login
                    </button>
                    <button id="signupTab" class="auth-tab" onclick="switchAuthTab('signup')">
                        Sign Up
                    </button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="auth-form active">
                    <h2>Welcome Back</h2>
                    <form onsubmit="event.preventDefault(); handleLogin();">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="loginUsername" 
                                placeholder="Username" 
                                required 
                                class="form-input"
                            />
                        </div>
                        <div class="input-group">
                            <input 
                                type="password" 
                                id="loginPassword" 
                                placeholder="Password" 
                                required 
                                class="form-input"
                            />
                        </div>
                        <button type="submit" class="auth-button primary" id="loginBtn">
                            <span id="loginButtonText">Login</span>
                        </button>
                    </form>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" class="auth-form hidden">
                    <h2>Create New Account</h2>
                    <form onsubmit="handleSignup(event)">
                        <div class="input-row">
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    id="signupUsername" 
                                    placeholder="Username" 
                                    required 
                                    class="form-input"
                                    minlength="3"
                                />
                            </div>
                            <div class="input-group">
                                <input 
                                    type="email" 
                                    id="signupEmail" 
                                    placeholder="Email (optional)" 
                                    class="form-input"
                                />
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <input 
                                    type="password" 
                                    id="signupPassword" 
                                    placeholder="Password" 
                                    required 
                                    class="form-input"
                                    minlength="6"
                                />
                            </div>
                            <div class="input-group">
                                <input 
                                    type="password" 
                                    id="signupConfirmPassword" 
                                    placeholder="Confirm Password" 
                                    required 
                                    class="form-input"
                                    minlength="6"
                                />
                            </div>
                        </div>
                        <button type="submit" class="auth-button success">
                            Create Account
                        </button>
                    </form>
                </div>

                <!-- Message Display -->
                <div id="authMessage" class="auth-message hidden"></div>
                
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="main-container hidden">
        <div class="app-card">
            <div class="app-header">
                <div class="app-logo">
                    <div class="shield-icon">üõ°Ô∏è</div>
                    <h1 class="app-title">VPN Dashboard</h1>
                </div>
                <p class="app-subtitle">Connected as <span id="currentUser">User</span></p>
            </div>
            
            <div class="system-status">
                <div class="status-title">VPN Status:</div>
                <div class="status-item">
                    <span id="statusIndicator" class="status-icon error">‚óè</span>
                    <span class="status-text" id="vpnStatusText">Disconnected</span>
                </div>
                <div class="status-item">
                    <span class="status-text">Server: <span id="currentServer">None</span></span>
                </div>
                <div class="status-item">
                    <span class="status-text" id="connectionIP">IP: Not connected</span>
                </div>
                <div class="status-item">
                    <span class="status-text" id="connectionTime">Duration: 00:00:00</span>
                </div>
            </div>

            <!-- Server Selection -->
            <div class="auth-container">
                <h3 style="color: white; margin-bottom: 16px;">Select VPN Server:</h3>
                <div id="serverList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Servers will be populated here -->
                </div>
                
                <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="connectBtn" class="auth-button success" onclick="handleConnect()">
                        Connect VPN
                    </button>
                    
                    <button id="disconnectBtn" class="auth-button primary hidden" onclick="handleDisconnect()">
                        Disconnect VPN
                    </button>
                    
                    <button class="auth-button primary" onclick="refreshStats()" style="background: linear-gradient(135deg, #757575 0%, #616161 100%);">
                        Refresh Stats
                    </button>
                    
                    <button class="auth-buttfon primary" onclick="handleLogout()" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include your real-api.js -->
    <script src="services/real-api.js"></script>
    
    <!-- Include your JavaScript (keeping existing functions) -->
    <script>
        // Your existing JavaScript code goes here
        // (All the functions from your current HTML)
        
        // Global state
        let currentVpnStatus = 'disconnected';
        let currentUser = null;
        let connectionTimer = null;
        let connectionStartTime = null;
        let selectedServer = null;

        // Initialize app
        // Add to your event listeners in react-index.html
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('App initializing...');
            await loadSystemInfo();
            
            // Set up VPN status listener
            if (window.electronAPI && window.electronAPI.onVPNStatusChanged) {
                window.electronAPI.onVPNStatusChanged(handleVPNStatusChange);
            }
            
            // Add this new listener
            if (window.electronAPI && window.electronAPI.onVPNActivationRequired) {
                window.electronAPI.onVPNActivationRequired(handleVPNActivationRequired);
            }
        });

        // Add this new function
        function handleVPNActivationRequired(data) {
            console.log('üîî VPN activation required:', data);
            
            // Show a notification to the user
            showMessage(`Please activate the "${data.configName}" tunnel in the WireGuard window that opened`, 'info');
        }

        // Load system information
        async function loadSystemInfo() {
            try {
                if (window.electronAPI) {
                    // Get app version
                    const version = await window.electronAPI.getAppVersion();
                    const appVersionEl = document.getElementById('appVersion');
                    if (appVersionEl) {
                        appVersionEl.textContent = `App Version: ${version}`;
                    }

                    // Check WireGuard with enhanced detection
                    await checkWireGuardStatus();

                    // Test backend connection
                    await testBackendConnection();

                    // Get initial VPN status
                    const vpnStatus = await window.electronAPI.getVPNStatus();
                    updateVPNStatus(vpnStatus.status || 'disconnected');
                }
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        // Enhanced WireGuard status checker
        async function checkWireGuardStatus() {
            try {
                const wgStatusElement = document.getElementById('wireGuardStatus');
                if (wgStatusElement) {
                    wgStatusElement.textContent = 'WireGuard: Checking...';
                    wgStatusElement.style.color = '#FF9800';
                }
                
                // Use enhanced detection
                const wgResult = await window.electronAPI.checkWireGuardAdvanced();
                
                if (wgResult.installed) {
                    if (wgStatusElement) {
                        const version = wgResult.version.split(' ')[0] || 'Installed';
                        wgStatusElement.textContent = `WireGuard: ‚úÖ ${version}`;
                        wgStatusElement.style.color = '#4CAF50';
                    }
                    
                    // Hide install button if exists
                    const installBtn = document.getElementById('wireGuardInstallBtn');
                    if (installBtn) {
                        installBtn.style.display = 'none';
                    }
                } else {
                    if (wgStatusElement) {
                        wgStatusElement.textContent = 'WireGuard: ‚ùå Not Installed';
                        wgStatusElement.style.color = '#f44336';
                    }
                    
                    // Show install button
                    showWireGuardInstallButton();
                }
                
                return wgResult;
            } catch (error) {
                console.error('WireGuard check failed:', error);
                const wgStatusElement = document.getElementById('wireGuardStatus');
                if (wgStatusElement) {
                    wgStatusElement.textContent = 'WireGuard: ‚ùå Check Failed';
                    wgStatusElement.style.color = '#f44336';
                }
                return { installed: false, error: error.message };
            }
        }

        // Show WireGuard install button on login screen
        function showWireGuardInstallButton() {
            const systemStatus = document.querySelector('.system-status');
            const existingBtn = document.getElementById('wireGuardInstallBtn');
            
            if (!existingBtn && systemStatus) {
                const installBtnHTML = `
                    <div class="status-item">
                        <button id="wireGuardInstallBtn" onclick="installWireGuardSilent()" class="auth-button success" style="
                            padding: 8px 16px;
                            font-size: 0.9em;
                            margin-top: 10px;
                        ">üõ†Ô∏è Install WireGuard</button>
                    </div>
                `;
                
                systemStatus.insertAdjacentHTML('beforeend', installBtnHTML);
            }
        }

        // Silent WireGuard installation from login screen
        async function installWireGuardSilent() {
            try {
                const installBtn = document.getElementById('wireGuardInstallBtn');
                const originalText = installBtn ? installBtn.textContent : '';
                
                if (installBtn) {
                    installBtn.textContent = 'üì• Downloading...';
                    installBtn.disabled = true;
                    installBtn.style.background = '#FF9800';
                }
                
                console.log('üõ†Ô∏è Starting WireGuard installation process...');
                
                const result = await window.electronAPI.installWireGuardSilent();
                
                if (result.success) {
                    if (installBtn) {
                        installBtn.textContent = '‚úÖ Installed!';
                        installBtn.style.background = '#4CAF50';
                    }
                    
                    // Refresh WireGuard status after 2 seconds
                    setTimeout(async () => {
                        await checkWireGuardStatus();
                        if (installBtn && installBtn.style.display !== 'none') {
                            installBtn.style.display = 'none';
                        }
                    }, 2000);
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Installation failed:', error);
                
                const installBtn = document.getElementById('wireGuardInstallBtn');
                if (installBtn) {
                    installBtn.textContent = '‚ùå Failed - Try Manual';
                    installBtn.style.background = '#f44336';
                    installBtn.disabled = false;
                    
                    // Change to manual download on click
                    installBtn.onclick = async () => {
                        console.log('üîó Opening manual download...');
                        await window.electronAPI.downloadWireGuard();
                        installBtn.textContent = 'üåê Download Opened';
                        installBtn.style.background = '#2196F3';
                    };
                    
                    // Reset after 5 seconds
                    setTimeout(() => {
                        installBtn.textContent = 'üõ†Ô∏è Install WireGuard';
                        installBtn.style.background = '#4CAF50';
                        installBtn.onclick = installWireGuardSilent;
                    }, 5000);
                }
            }
        }

        // Test backend connection
        async function testBackendConnection() {
            try {
                const backendStatusElement = document.getElementById('backendStatus');
                backendStatusElement.textContent = 'Backend: Testing...';
                
                const result = await window.realAPI.testConnection();
                
                if (result.success) {
                    backendStatusElement.textContent = 'Backend: ‚úÖ Online';
                    backendStatusElement.style.color = '#4CAF50';
                } else {
                    backendStatusElement.textContent = 'Backend: ‚ùå Offline';
                    backendStatusElement.style.color = '#f44336';
                }
            } catch (error) {
                document.getElementById('backendStatus').textContent = 'Backend: ‚ùå Error';
                document.getElementById('backendStatus').style.color = '#f44336';
                console.error('Backend test failed:', error);
            }
        }

        // Switch between login and signup
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const authMessage = document.getElementById('authMessage');
            
            // Clear messages
            authMessage.classList.add('hidden');
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                loginForm.classList.add('active');
                signupForm.classList.add('hidden');
                signupForm.classList.remove('active');
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
            } else {
                loginForm.classList.add('hidden');
                loginForm.classList.remove('active');
                signupForm.classList.remove('hidden');
                signupForm.classList.add('active');
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
            }
        }

        // Handle login
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('authMessage');
            const buttonText = document.getElementById('loginButtonText');
            const button = document.getElementById('loginBtn');

            if (!username || !password) {
                showMessage('Please enter username and password', 'error');
                return;
            }

            try {
                // Show loading
                button.disabled = true;
                buttonText.textContent = 'Logging in...';
                showMessage('Connecting to server...', 'info');

                console.log('Attempting login for:', username);

                // Real login attempt
                const loginResult = await window.realAPI.login(username, password);

                if (loginResult.success) {
                    // Success
                    currentUser = loginResult.user;
                    document.getElementById('currentUser').textContent = loginResult.user.username;
                    
                    // Load VPN servers
                    await loadVPNServers();
                    
                    // Switch to dashboard
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('dashboardScreen').classList.remove('hidden');

                    showMessage(loginResult.message, 'success');
                    
                    console.log('Login successful:', loginResult);
                } else {
                    throw new Error(loginResult.message);
                }
            } catch (error) {
                console.error('Login failed:', error);
                showMessage(`Login failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                buttonText.textContent = 'Login';
            }
        }

        // Handle signup
        async function handleSignup(event) {
            event.preventDefault();
            
            try {
                console.log('üîÑ Signup form submitted');
                
                const usernameInput = document.getElementById('signupUsername');
                const emailInput = document.getElementById('signupEmail');
                const passwordInput = document.getElementById('signupPassword');
                const confirmPasswordInput = document.getElementById('signupConfirmPassword');
                
                if (!usernameInput || !passwordInput) {
                    throw new Error('Required form elements not found');
                }
                
                const username = usernameInput.value;
                const email = emailInput ? emailInput.value : '';
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : password;
                
                console.log('üîç Form values:', {
                    username,
                    email,
                    passwordLength: password ? password.length : 0
                });
                
                // Validate inputs
                if (!username || username.trim().length < 3) {
                    showMessage('Username must be at least 3 characters long', 'error');
                    return;
                }
                
                if (!password || password.length < 6) {
                    showMessage(`Password must be at least 6 characters long (you entered ${password ? password.length : 0} characters)`, 'error');
                    return;
                }
                
                if (confirmPassword && password !== confirmPassword) {
                    showMessage('Passwords do not match', 'error');
                    return;
                }
                
                // Show loading state
                const submitButton = event.target.querySelector('button[type="submit"]');
                const originalText = submitButton ? submitButton.textContent : '';
                if (submitButton) {
                    submitButton.textContent = 'Creating Account...';
                    submitButton.disabled = true;
                }
                
                console.log('üìù Calling realAPI.register...');
                const result = await window.realAPI.register(username, password, email);
                
                if (result.success) {
                    console.log('‚úÖ Registration successful!');
                    showMessage('Account created successfully! Please login.', 'success');
                    
                    // Clear form
                    event.target.reset();
                    
                    // Switch to login tab after 2 seconds
                    setTimeout(() => {
                        switchAuthTab('login');
                        document.getElementById('loginUsername').value = username;
                    }, 2000);
                    
                } else {
                    console.error('‚ùå Registration failed:', result.message);
                    showMessage(`Signup failed: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Signup error:', error);
                showMessage(`Signup failed: ${error.message}`, 'error');
            } finally {
                const submitButton = event.target.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'Create Account';
                    submitButton.disabled = false;
                }
            }
        }

        // Show message function
        function showMessage(text, type) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.textContent = text;
            messageDiv.className = `auth-message ${type}`;
            messageDiv.classList.remove('hidden');
            
            // Auto hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Load VPN servers
        async function loadVPNServers() {
            try {
                console.log('üåê Loading VPN servers from real API...');
                
                const serverList = document.getElementById('serverList');
                if (serverList) {
                    serverList.innerHTML = '<div style="text-align: center; color: #FF9800; padding: 20px;">üîÑ Loading servers...</div>';
                }
                
                const result = await window.realAPI.getVPNServers();
                
                if (result.success && result.servers) {
                    displayVPNServers(result.servers);
                    console.log('‚úÖ Loaded', result.servers.length, 'servers from backend');
                } else {
                    throw new Error(result.message || 'Failed to load servers');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load VPN servers:', error);
                
                const serverList = document.getElementById('serverList');
                if (serverList) {
                    serverList.innerHTML = `
                        <div style="color: #f44336; padding: 20px; text-align: center; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
                            ‚ùå Failed to load servers: ${error.message}
                            <br><br>
                            <button onclick="loadVPNServers()" class="auth-button primary" style="padding: 8px 16px; font-size: 0.9em;">
                                üîÑ Retry
                            </button>
                        </div>
                    `;
                }
            }
        }

        function displayVPNServers(servers) {
            const serverList = document.getElementById('serverList');
            if (!serverList) {
                console.error('‚ùå serverList element not found');
                return;
            }
            
            console.log('üñ•Ô∏è Displaying servers:', servers);
            
            if (!servers || servers.length === 0) {
                serverList.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.6);">No servers available</div>';
                return;
            }
            
            let serversHTML = '';
            
            servers.forEach(server => {
                const isSelected = selectedServer && selectedServer.id === server.id;
                
                serversHTML += `
                    <div class="server-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectServer(${server.id}, '${server.name}', '${server.location}', '${server.endpoint}')"
                         data-server-id="${server.id}"
                         style="
                            display: flex;
                            align-items: center;
                            padding: 12px;
                            margin: 5px 0;
                            background: rgba(255, 255, 255, 0.05);
                            border-radius: 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            border: 2px solid ${isSelected ? '#4CAF50' : 'transparent'};
                         ">
                        <div style="font-size: 1.8em; margin-right: 15px; min-width: 40px;">
                            ${server.flag || 'üåç'}
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; font-size: 1.1em; color: white;">
                                ${server.name}
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.8; color: rgba(255, 255, 255, 0.7); margin-top: 2px;">
                                ${server.location}
                            </div>
                        </div>
                        <div style="color: #4CAF50; font-size: 0.9em; font-weight: 500; min-width: 60px; text-align: right;">
                            ${server.ping || 'Unknown'}
                        </div>
                    </div>
                `;
            });
            
            serverList.innerHTML = serversHTML;
            console.log('‚úÖ Server list HTML updated with', servers.length, 'servers');
        }

        // Select server
        function selectServer(id, name, location, endpoint) {
            selectedServer = {
                id: id,
                name: name,
                location: location,
                endpoint: endpoint
            };
            
            console.log('üìç Server selected:', selectedServer);
            
            // Remove selection from all servers
            document.querySelectorAll('.server-item').forEach(item => {
                item.classList.remove('selected');
                item.style.border = '2px solid transparent';
            });
            
            // Add selection to clicked server
            const clickedServer = document.querySelector(`[data-server-id="${id}"]`);
            if (clickedServer) {
                clickedServer.classList.add('selected');
                clickedServer.style.border = '2px solid #4CAF50';
                clickedServer.style.background = 'rgba(76, 175, 80, 0.2)';
                console.log('‚úÖ Visual selection applied to server:', name);
            }
            
            // Update current server display
            document.getElementById('currentServer').textContent = name;
        }

        // Update VPN status
        function updateVPNStatus(status) {
            currentVpnStatus = status;
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('vpnStatusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (!indicator || !statusText) {
                console.warn('Status elements not found in DOM');
                return;
            }

            // Reset visual state first
            indicator.className = 'status-icon';
            // Important: fully clear previous pulse animation
            indicator.style.removeProperty('animation');

            switch (status) {
                case 'connected':
                    indicator.classList.add('success');
                    indicator.textContent = '‚óè';
                    statusText.textContent = 'Connected';
                    if (connectBtn) { connectBtn.classList.add('hidden'); connectBtn.disabled = false; }
                    if (disconnectBtn) { disconnectBtn.classList.remove('hidden'); disconnectBtn.disabled = false; }
                    connectionStartTime = new Date();
                    startConnectionTimer();
                    break;
                    
                case 'connecting':
                    indicator.classList.add('error');
                    indicator.textContent = '‚óè';
                    indicator.style.animation = 'pulse 1s infinite';
                    statusText.textContent = 'Connecting...';
                    if (connectBtn) connectBtn.disabled = true;
                    if (disconnectBtn) { disconnectBtn.classList.add('hidden'); disconnectBtn.disabled = true; }
                    break;

                case 'disconnecting':
                    indicator.classList.add('error');
                    indicator.textContent = '‚óè';
                    indicator.style.animation = 'pulse 1s infinite';
                    statusText.textContent = 'Disconnecting...';
                    if (connectBtn) connectBtn.disabled = true;
                    if (disconnectBtn) { disconnectBtn.disabled = true; disconnectBtn.classList.remove('hidden'); }
                    break;

                default: // 'disconnected'
                    indicator.classList.add('error');
                    indicator.textContent = '‚óè';
                    statusText.textContent = 'Disconnected';
                    if (connectBtn) { connectBtn.classList.remove('hidden'); connectBtn.disabled = false; }
                    if (disconnectBtn) { disconnectBtn.classList.add('hidden'); disconnectBtn.disabled = false; }
                    stopConnectionTimer();
                    break;
            }

            console.log('VPN status updated to:', status);
        }

        // Force reset helper in case any async path leaves the UI inconsistent
        function forceDisconnectedUI() {
            updateVPNStatus('disconnected');
            const currentServerEl = document.getElementById('currentServer');
            const connectionIPEl = document.getElementById('connectionIP');
            if (currentServerEl) currentServerEl.textContent = 'None';
            if (connectionIPEl) connectionIPEl.textContent = 'IP: Not connected';
        }

        // Handle disconnection
        async function handleDisconnect() {
            try {
                console.log('üîå Disconnecting VPN...');
                updateVPNStatus('disconnecting');

                const result = await window.electronAPI.disconnectVPN();

                // Always force UI to Disconnected at the end
                forceDisconnectedUI();

                if (result && result.success) {
                    console.log('‚úÖ VPN disconnected successfully');
                    showMessage('VPN Disconnected', 'info');
                } else if (result && result.error) {
                    console.warn('‚ö†Ô∏è Disconnection returned error:', result.error);
                    showMessage(`Disconnection warning: ${result.error}`, 'warning');
                }
            } catch (error) {
                console.error('VPN disconnection failed:', error);
                forceDisconnectedUI();
                showMessage(`Disconnection Error: ${error.message}`, 'error');
            }
        }

        // // Handle VPN connection
        // async function handleConnect() {
        //     try {
        //         const currentUser = window.realAPI.getCurrentUser();
        //         if (!currentUser) {
        //             console.error('‚ùå No user logged in');
        //             showMessage('Please login first', 'error');
        //             return;
        //         }

        //         if (!selectedServer) {
        //             showMessage('Please select a server first', 'error');
        //             return;
        //         }

        //         console.log('üöÄ Starting REAL VPN connection process...');
        //         updateVPNStatus('connecting');
                
        //         // Continue with VPN configuration and connection...
        //         showMessage('Requesting VPN configuration...', 'info');
                
        //         const configResult = await window.realAPI.generateVPNConfig();
                
        //         if (!configResult.success) {
        //             throw new Error(configResult.message);
        //         }

        //         console.log('‚úÖ VPN config received, client IP:', configResult.client_ip);
        //         showMessage(`Configuration received (IP: ${configResult.client_ip})`, 'success');

        //         // Connect using real WireGuard with actual config
        //         console.log('üîó Establishing WireGuard connection...');
        //         showMessage('Connecting to VPN server...', 'info');
                
        //         const result = await window.electronAPI.connectVPNReal({
        //             server: selectedServer.name,
        //             endpoint: selectedServer.endpoint,
        //             config: configResult.config,
        //             clientIP: configResult.client_ip
        //         });

        //         if (result.success) {
        //             console.log('üéâ REAL VPN connection established!');
                    
        //             // Log connection to backend
        //             await window.realAPI.logVPNConnection(selectedServer.endpoint);
                    
        //             // Update status
        //             showMessage('VPN Connected Successfully!', 'success');
                    
        //         } else {
        //             throw new Error(result.message);
        //         }
        //     } catch (error) {
        //         console.error('‚ùå VPN connection failed:', error);
        //         updateVPNStatus('disconnected');
        //         showMessage(`Connection Error: ${error.message}`, 'error');
        //     }
        // }

        // Handle disconnection
        async function handleDisconnect() {
            try {
                console.log('üîå Disconnecting VPN...');
                updateVPNStatus('disconnecting');
                
                const result = await window.electronAPI.disconnectVPN();
                
                updateVPNStatus('disconnected');
                if (result.success) {
                    console.log('‚úÖ VPN disconnected successfully');
                    // Log disconnection to backend
                    // await window.realAPI.logVPNDisconnection();
                    
                    showMessage('VPN Disconnected', 'info');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('VPN disconnection failed:', error);
                updateVPNStatus('disconnected');
                showMessage(`Disconnection Error: ${error.message}`, 'error');
            }
        }

        // Refresh VPN statistics
        async function refreshStats() {
            try {
                console.log('Refreshing VPN statistics...');
                
                // Test backend connection
                await testBackendConnection();
                
                showMessage(`Stats refreshed at ${new Date().toLocaleTimeString()}`, 'success');
                
            } catch (error) {
                console.error('Failed to refresh stats:', error);
                showMessage(`Failed to refresh stats: ${error.message}`, 'error');
            }
        }

        // In your React app's connect function:
        // Replace the existing handleConnect function 
        async function handleConnect() {
            try {
                const currentUser = window.realAPI.getCurrentUser();
                if (!currentUser) {
                    console.error('‚ùå No user logged in');
                    showMessage('Please login first', 'error');
                    return;
                }

                if (!selectedServer) {
                    showMessage('Please select a server first', 'error');
                    return;
                }

                console.log('üöÄ Starting VPN connection process...');
                updateVPNStatus('connecting');
                
                showMessage('Requesting VPN configuration...', 'info');
                
                // Generate VPN config
                const configResult = await window.realAPI.generateVPNConfig();
                
                if (!configResult.success) {
                    throw new Error(configResult.message || 'Failed to generate config');
                }

                console.log('‚úÖ VPN config received, client IP:', configResult.client_ip);
                showMessage(`Configuration received (IP: ${configResult.client_ip})`, 'success');
                
                // Save config to file
                const configPath = await window.electronAPI.saveConfigToFile(configResult.config);
                console.log('üìÅ Config saved to:', configPath);

                // Connect using WireGuard
                console.log('üîó Establishing WireGuard connection...');
                showMessage('Connecting to VPN server...', 'info');
                
                const result = await window.electronAPI.connectVPN(configPath);
                
                
                try {
                    // Log connection to backend regardless of command result
                    await window.realAPI.logVPNConnection(selectedServer.endpoint);
                    
                    if (result.success) {
                        console.log('üéâ VPN connection established!');
                        
                        // Update status
                        updateVPNStatus('connected');
                        document.getElementById('connectionIP').textContent = `IP: ${configResult.client_ip}`;
                        showMessage('VPN Connected Successfully!', 'success');
                    } else {
                        console.warn('‚ö†Ô∏è Initial connection command returned error but tunnel may still be active');
                        console.warn('Error was:', result.error);
                        
                        // Start verification process - may still be connected despite error
                        verifyVPNConnection(configResult.client_ip);
                    }
                } catch (apiError) {
                    console.error('‚ùå API logging error:', apiError);
                    // Still try to verify connection even if logging fails
                    verifyVPNConnection(configResult.client_ip);
                }

            } catch (error) {
                console.error('‚ùå VPN connection failed:', error);
                updateVPNStatus('disconnected');
                showMessage(`Connection Error: ${error.message}`, 'error');
            }
        }


        // Add this function after your handleConnect function

        // Verify VPN connection status
        function verifyVPNConnection(clientIP) {
            console.log('üîç Verifying VPN connection status...');
            
            // Set a timeout to check connection status after 3 seconds
            setTimeout(async () => {
                try {
                    // Method 1: Check if interface exists
                    const statusCheck = await window.electronAPI.checkVPNStatus();
                    
                    console.log('üîç VPN status check result:', statusCheck);
                    
                    if (statusCheck.isActive) {
                        console.log('‚úÖ VPN connection verified as active!');
                        updateVPNStatus('connected');
                        document.getElementById('connectionIP').textContent = `IP: ${clientIP}`;
                        showMessage('VPN Connected Successfully!', 'success');
                        return;
                    }
                    
                    // Method 2: Check if our IP has changed
                    try {
                        console.log('üåê Checking external IP...');
                        
                        // Try to fetch our external IP
                        const ipCheckUrl = 'https://api.ipify.org?format=json';
                        const response = await fetch(ipCheckUrl);
                        const data = await response.json();
                        
                        console.log('üì° Current external IP:', data.ip);
                        
                        // If the IP has changed, we're connected
                        if (data.ip !== window.originalIP) {
                            console.log('‚úÖ IP change detected - VPN connected!');
                            updateVPNStatus('connected');
                            document.getElementById('connectionIP').textContent = `IP: ${clientIP} (External: ${data.ip})`;
                            showMessage('VPN Connected Successfully!', 'success');
                            return;
                        }
                    } catch (ipError) {
                        console.log('‚ùå IP check failed:', ipError);
                        // Continue to final method even if this fails
                    }
                    
                    // If we're here, we need to manually check the service
                    console.log('‚ö†Ô∏è Standard checks failed, but tunnel may still be active');
                    
                    // Ask the user about the connection
                    const isConnected = confirm('Is your VPN connected? (Check Windows network icon for VPN connection)');
                    if (isConnected) {
                        console.log('üë§ User confirmed VPN is connected');
                        updateVPNStatus('connected');
                        document.getElementById('connectionIP').textContent = `IP: ${clientIP}`;
                        showMessage('VPN Connected Successfully!', 'success');
                    } else {
                        console.log('üë§ User confirmed VPN is NOT connected');
                        updateVPNStatus('disconnected');
                        showMessage('VPN Connection failed - please try again', 'error');
                    }
                    
                } catch (error) {
                    console.error('‚ùå VPN verification failed:', error);
                }
            }, 3000);
        }


        // // In your disconnect function:
        // async function handleDisconnect() {
        //     try {
        //         setStatus('disconnecting');
                
        //         const result = await window.electronAPI.disconnectVPN();
        //         if (!result.success) {
        //             showMessage(`Failed to disconnect: ${result.error}`, 'warning');
        //         }
                
        //         // Always consider disconnected even if there was an error
        //         setStatus('disconnected');
        //         setCurrentServer(null);
        //         setClientIP(null);
                
        //         // Log disconnection
        //         await api.logVPNDisconnection();
                
        //     } catch (error) {
        //         showMessage(`Disconnection error: ${error.message}`, 'warning');
        //         setStatus('disconnected');
        //     }
        // }

        // Add a function to check status periodically
        function setupVPNStatusCheck() {
            const checkInterval = setInterval(async () => {
                if (status === 'connected') {
                    const result = await window.electronAPI.checkVPNStatus();
                    if (!result.isActive) {
                        // VPN disconnected unexpectedly
                        showMessage('VPN connection lost', 'warning');
                        setStatus('disconnected');
                        setCurrentServer(null);
                        setClientIP(null);
                    }
                }
            }, 10000); // Check every 10 seconds
            
            // Clean up interval when component unmounts
            return () => clearInterval(checkInterval);
        }
    </script>
</body>
</html>